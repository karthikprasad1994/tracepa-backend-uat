 public async Task ExecuteAllSqlScriptsAsync(string connectionString, string scriptsFolderPath)
 {
     try
     {
         string[] scriptFiles = {
     Path.Combine(scriptsFolderPath, "Createtable.sql"),
     Path.Combine(scriptsFolderPath, "Insertvalues.sql"),
     Path.Combine(scriptsFolderPath, "CreateProcedures.sql")
 };

         using (var connection = new SqlConnection(connectionString))
         {
             await connection.OpenAsync();
             using (var transaction = connection.BeginTransaction())  // ✅ Ensure atomic execution
             {
                 try
                 {
                     foreach (string scriptPath in scriptFiles)
                     {
                         if (File.Exists(scriptPath))
                         {
                             string script = await File.ReadAllTextAsync(scriptPath);
                             string[] commands = Regex.Split(script, @"(?i)^\s*GO\s*$", RegexOptions.Multiline);

                             foreach (string commandText in commands)
                             {
                                 string trimmedCommand = commandText.Trim();
                                 if (!string.IsNullOrEmpty(trimmedCommand))
                                 {
                                     try
                                     {
                                         using (var command = new SqlCommand(trimmedCommand, connection, transaction))
                                         {
                                             command.CommandTimeout = 120;

                                             // ✅ Identity Insert Handling
                                             if (trimmedCommand.Contains("INSERT INTO") && trimmedCommand.Contains("IDENTITY"))
                                             {
                                                 await new SqlCommand("SET IDENTITY_INSERT ON;", connection, transaction).ExecuteNonQueryAsync();
                                             }

                                             await command.ExecuteNonQueryAsync();
                                         }
                                     }
                                     catch (SqlException sqlEx)
                                     {
                                         Console.WriteLine($"SQL Execution Error in {Path.GetFileName(scriptPath)}: {sqlEx.Message}\nCommand: {trimmedCommand}");
                                     }
                                 }
                             }

                             Console.WriteLine($"Successfully executed: {Path.GetFileName(scriptPath)}");
                         }
                         else
                         {
                             Console.WriteLine($"File not found: {scriptPath}");
                         }
                     }

                     await transaction.CommitAsync();  // ✅ Commit after successful execution
                 }
                 catch (Exception ex)
                 {
                     await transaction.RollbackAsync();  // ✅ Rollback if any error occurs
                     Console.WriteLine($"Transaction failed: {ex.Message}");
                 }
             }
         }

         Console.WriteLine("All SQL scripts executed successfully.");
     }
     catch (Exception ex)
     {
         Console.WriteLine($"General error executing SQL scripts: {ex.Message}");
     }
 }




{
  
  "mcrCustomerName": "krishna",
  "mcrCustomerCode": "k001",
  "mcrCustomerEmail": "harsha54@gmail.com",
  "mcrCustomerTelephoneNo": "5432187654",
  
}




    public async Task<IActionResult> SignUpUserAsync(RegistrationDto registerModel)
    {
        try
        {
            using var connection = new SqlConnection(_configuration.GetConnectionString("CustomerRegistrationConnection"));
            await connection.OpenAsync();

            // Step 1: Check if customer already exists
            var existingCustomer = await connection.QueryFirstOrDefaultAsync<int>(
                @"SELECT COUNT(1) 
          FROM MMCS_CustomerRegistration 
          WHERE MCR_CustomerEmail = @Email OR MCR_CustomerTelephoneNo = @Phone",
                new { Email = registerModel.McrCustomerEmail, Phone = registerModel.McrCustomerTelephoneNo });

            if (existingCustomer > 0)
            {
                return new ConflictObjectResult(new
                {
                    statuscode = 409,
                    message = "Customer with this email or phone number already exists."
                });
            }

            // Step 2: Generate Customer Code and IDs
            int maxMcrId = (await connection.ExecuteScalarAsync<int?>(
                "SELECT ISNULL(MAX(MCR_ID), 0) FROM MMCS_CustomerRegistration") ?? 0) + 1;

            string currentYear = DateTime.Now.Year.ToString("yy");
            string yearPrefix = $"TR{currentYear}";

            int customerCount = await connection.ExecuteScalarAsync<int>(
    "SELECT COUNT(*) FROM MMCS_CustomerRegistration  WHERE MCR_CustomerCode LIKE @Prefix + '%'",
new { Prefix = yearPrefix });

            int nextNumber = customerCount + 1;
            string newCustomerCode = $"{yearPrefix}_{nextNumber:D3}";
            string productKey = $"PRD-{Guid.NewGuid().ToString("N").Substring(0, 8).ToUpper()}";

            // Step 3: Insert into MMCS_CustomerRegistration
            string insertSql = @"
        INSERT INTO MMCS_CustomerRegistration 
        (MCR_ID, MCR_MP_ID, MCR_CustomerName, MCR_CustomerEmail, MCR_CustomerTelephoneNo, 
         MCR_Status, MCR_TStatus, MCR_CustomerCode, MCR_ProductKey)
        VALUES 
        (@McrId, @McrMpId, @McrCustomerName, @McrCustomerEmail, @McrCustomerTelephoneNo, 
         'A', 'T', @McrCustomerCode, @McrProductKey)";

            var rowsInserted = await connection.ExecuteAsync(insertSql, new
            {
                McrId = maxMcrId,
                McrMpId = 2,
                McrCustomerName = registerModel.McrCustomerName,
                McrCustomerEmail = registerModel.McrCustomerEmail,
                McrCustomerTelephoneNo = registerModel.McrCustomerTelephoneNo,
                McrCustomerCode = newCustomerCode,
                McrProductKey = productKey
            });

            if (rowsInserted == 0)
            {
                return new ObjectResult(new { statuscode = 500, message = "Failed to insert customer." }) { StatusCode = 500 };
            }

            Console.WriteLine("✅ Customer inserted via Dapper.");

            // Step 4: Create Customer Database
            await CreateCustomerDatabaseAsync(newCustomerCode);

            // Step 5: Setup Schema
            string connectionStringTemplate = _configuration.GetConnectionString("NewDatabaseTemplate");
            string newDbConnectionString = string.Format(connectionStringTemplate, newCustomerCode);

            string scriptsFolderPath = Path.Combine(_env.ContentRootPath, "SqlScripts", "Cleaned_Sign-up.sql");
            await ExecuteAllSqlScriptsAsync(newDbConnectionString, scriptsFolderPath);

            // Step 6: Insert Admin User in new DB (EF Core)
            var optionsBuilder = new DbContextOptionsBuilder<DynamicDbContext>();
            optionsBuilder.UseSqlServer(newDbConnectionString);

            using var newDbContext = new DynamicDbContext(optionsBuilder.Options);

            int maxUserId = (await newDbContext.SadUserDetails.MaxAsync(c => (int?)c.UsrId) ?? 0) + 1;

            var lastUserCode = await newDbContext.SadUserDetails
                .Where(u => u.UsrCode.StartsWith("EMP"))
                .OrderByDescending(u => u.UsrCode)
                .Select(u => u.UsrCode)
                .FirstOrDefaultAsync();

            int nextUserCodeNumber = 1;
            if (!string.IsNullOrEmpty(lastUserCode) && int.TryParse(lastUserCode.Substring(3), out int lastCodeNumber))
            {
                nextUserCodeNumber = lastCodeNumber + 1;
            }

            string newUserCode = $"EMP{nextUserCodeNumber:D3}";
            string hashedPassword = BCrypt.Net.BCrypt.HashPassword("sa");

            var adminUser = new Models.UserModels.SadUserDetail
            {
                UsrId = maxUserId,
                UsrCode = newUserCode,
                UsrNode = 2,
                UsrFullName = "Admin",
                UsrLoginName = "sa",
                UsrPassWord = hashedPassword,
                UsrEmail = registerModel.McrCustomerEmail,
                UsrMobileNo = registerModel.McrCustomerTelephoneNo,
                UsrDutyStatus = "A",
                UsrDelFlag = "A",
                UsrStatus = "U",
                UsrType = "C",
                UsrIsLogin = "Y"
            };

            await newDbContext.SadUserDetails.AddAsync(adminUser);
            await newDbContext.SaveChangesAsync();

            return new OkObjectResult(new
            {
                statuscode = 201,
                message = "Customer registered successfully."
            });
        }
        catch (Exception ex)
        {
            return new ObjectResult(new
            {
                statuscode = 500,
                message = "Internal server error",
                error = ex.Message
            })
            {
                StatusCode = 500
            };
        }
    }




 public async Task<LoginResponse> AuthenticateUserAsync(string email, string password)
 {
     try
     {
         // ✅ Step 1: Find Customer Code from Registration Database
         var customer = await _customerRegistrationContext.MmcsCustomerRegistrations

             .Where(c => c.MCR_emails  == email)
             .Select(c => new { c.McrCustomerCode })
             .FirstOrDefaultAsync();

         if (customer == null)
         {
             return new LoginResponse { StatusCode = 404, Message = "Email not found" };
         }

         // ✅ Step 2: Get Connection String for Customer Database
         string connectionStringTemplate = _configuration.GetConnectionString("NewDatabaseTemplate");
         string newDbConnectionString = string.Format(connectionStringTemplate, customer.McrCustomerCode);

         // ✅ Step 3: Use DynamicDbContext with new Connection String
         var optionsBuilder = new DbContextOptionsBuilder<DynamicDbContext>();
         optionsBuilder.UseSqlServer(newDbConnectionString);

         using (var newDbContext = new DynamicDbContext(optionsBuilder.Options))
         {
             // ✅ Step 4: Fetch user from the correct database
             var userDto = await newDbContext.SadUserDetails
                 .AsNoTracking()
                 .Where(u => u.UsrEmail == email)
                 .Select(u => new LoginDto
                 {
                     UsrEmail = u.UsrEmail,
                     UsrPassWord = u.UsrPassWord
                 })
                 .SingleOrDefaultAsync();

             if (userDto == null)
             {
                 return new LoginResponse { StatusCode = 404, Message = "Invalid Email" };
             }

             // ✅ Debugging: Log stored hashed password
             Console.WriteLine($"[DEBUG] Stored Hashed Password: {userDto.UsrPassWord}");

             // ✅ Step 5: Verify Password
             bool isPasswordValid = BCrypt.Net.BCrypt.Verify(password, userDto.UsrPassWord);

             if (!isPasswordValid)
             {
                 return new LoginResponse { StatusCode = 401, Message = "Invalid Password" };
             }

             // ✅ Step 6: Fetch User ID
             var userId = await newDbContext.SadUserDetails
                 .AsNoTracking()
                 .Where(a => a.UsrEmail == email)
                 .Select(a => a.UsrId)
                 .FirstOrDefaultAsync();

             // ✅ Step 7: Generate JWT Token
             string token = GenerateJwtToken(userDto);
           

             return new LoginResponse
             {
                 StatusCode = 200,
                 Message = "Login successful",
                 Token = token,
                 UsrId = userId
             };
         }
     }
     catch (Exception ex)
     {
         Console.WriteLine($"[ERROR] Exception in AuthenticateUserAsync: {ex.Message}");
         return new LoginResponse
         {
             StatusCode = 500,
             Message = $"An error occurred: {ex.Message}"
         };
     }
 }